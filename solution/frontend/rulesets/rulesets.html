<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A2A Security Dashboard - 룰셋</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="rulesets.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="app-container" data-page="ruleset">
      <header class="app-header">
        <div class="logo">A2A SECURE</div>
        <nav class="main-nav">
          <a href="/dashboard" class="nav-link">대시보드</a>
          <a href="/agents" class="nav-link">에이전트</a>
          <a href="/logs" class="nav-link">로그</a>
          <a href="/rulesets/" class="nav-link active">룰셋</a>
        </nav>
      </header>

      <main class="content-area">
        <div class="content-wrapper">
          <section id="view-groups" class="active">
            <div class="group-layout">
              <aside class="group-sidebar widget">
                <div class="widget-header-with-button compact">
                  <h3 class="widget-title">그룹 목록</h3>
                  <button class="btn-icon" id="btn-add-group" title="그룹 추가">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <ul id="group-list" class="group-nav-list"></ul>
              </aside>

              <article class="group-detail-panel widget">
                <div id="group-detail-placeholder" class="empty-placeholder">
                  <i class="fas fa-arrow-left"></i>
                  <p>그룹을 선택하여 멤버와 보안 정책을 관리하세요.</p>
                </div>

                <div id="group-detail-content" class="hidden">
                  <div class="group-header">
                    <div class="group-info">
                      <h2 id="selected-group-name" >그룹 이름</h2>
                      <p id="selected-group-desc">그룹 설명</p>
                    </div>
                    <div class="group-actions">
                      <button
                        class="btn-secondary btn-small"
                        id="btn-edit-group"
                      >
                        수정
                      </button>
                      <button
                        class="btn-danger btn-small"
                        id="btn-delete-group"
                      >
                        삭제
                      </button>
                    </div>
                  </div>

                  <hr class="divider" />

                  <div class="group-section">
                    <div class="section-header">
                      <h4><i class="fas fa-user-friends"></i> 그룹 멤버</h4>
                      <button class="btn-secondary btn-xs" id="btn-add-member">
                        멤버 추가
                      </button>
                    </div>
                    <div class="table-container" style="max-height: 200px">
                      <table class="ruleset-table">
                        <thead>
                          <tr>
                            <th style="width: 30%; text-align: center">이름</th>
                            <th style="width: 25%; text-align: center">직급</th>
                            <th style="width: 35%; text-align: center">
                              이메일
                            </th>
                            <th style="width: 10%; text-align: right"></th>
                          </tr>
                        </thead>
                        <tbody id="group-member-table-body"></tbody>
                      </table>
                    </div>
                  </div>

                  <hr class="divider" />

                  <div class="group-section flex-grow">
                    <div class="section-header">
                      <h4>
                        <i class="fas fa-shield-alt"></i> 그룹 접근 허용 목록
                      </h4>
                      <button
                        class="btn-primary btn-xs"
                        id="btn-create-group-rule"
                      >
                        허용 정책 추가
                      </button>
                    </div>
                    <div class="table-container">
                      <table class="ruleset-table">
                        <thead>
                          <tr>
                            <th style="width: 20%; text-align: center">
                              정책 이름
                            </th>
                            <th style="width: 50%; text-align: center">설명</th>
                            <th style="width: 15%; text-align: center">
                              활성화
                            </th>
                            <th style="width: 15%; text-align: right"></th>
                          </tr>
                        </thead>
                        <tbody id="group-rules-body"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </article>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div class="modal-overlay hidden" id="token-modal">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="token-modal-title">
        <div class="modal-header">
          <h3 id="token-modal-title">관리자 JWT 입력</h3>
          <button class="btn-secondary" id="token-modal-close" type="button">닫기</button>
        </div>
        <div class="modal-content">
          <form id="token-form" class="modal-form">
            <label for="token-input">관리자 JWT 토큰</label>
            <input
              type="password"
              id="token-input"
              placeholder="Bearer 토큰을 붙여넣어주세요"
              autocomplete="off"
              required
            />
            <p id="token-status" class="text-secondary text-sm"></p>
            <div class="form-actions">
              <button type="submit" class="btn-primary">인증</button>
              <button type="button" class="btn-secondary" id="token-form-cancel">
                취소
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <template id="ruleset-row-template">
      <tr>
        <td
          class="ruleset-name-cell ruleset-name font-medium"
          style="text-align: center"
        ></td>

        <td
          class="ruleset-desc-cell ruleset-desc text-truncate"
          style="text-align: center"
        ></td>

        <td class="ruleset-type"></td>
        <td class="ruleset-status text-center"></td>
        <td
          class="ruleset-actions"
          style="text-align: right; white-space: nowrap"
        >
          <button class="btn-icon" data-action="edit" title="수정">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon delete" data-action="delete" title="삭제">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>
    </template>

    <template id="tool-row-template">
      <tr>
        <td class="tool-name font-medium"></td>
        <td class="tool-desc text-secondary text-sm"></td>
        <td class="tool-policy-status">
          <span class="status-badge empty">정책 없음</span>
        </td>
        <td class="tool-actions" style="text-align: right">
          <button class="btn-secondary btn-small" data-action="configure">
            정책 설정
          </button>
        </td>
      </tr>
    </template>

    <template id="member-row-template">
      <tr>
        <td class="member-name font-medium" style="text-align: center"></td>
        <td
          class="member-title text-secondary text-sm"
          style="text-align: center"
        ></td>
        <td class="member-email text-secondary" style="text-align: center"></td>
        <td
          class="member-actions"
          style="text-align: right; white-space: nowrap"
        >
          <button class="btn-icon delete" title="멤버 삭제">
            <i class="fas fa-times"></i>
          </button>
        </td>
      </tr>
    </template>

    <div class="modal-overlay hidden" id="member-modal">
      <div class="modal" style="width: 700px">
        <div class="modal-header">
          <h3>멤버 추가</h3>
        </div>
        <div class="modal-content">
          <div class="search-container" style="margin-bottom: 1rem">
            <div class="input-with-icon">
              <i class="fas fa-search input-icon"></i>
              <input
                type="text"
                id="user-search-input"
                placeholder="이름, 직급 또는 이메일로 검색..."
                class="full-width"
              />
            </div>
          </div>

          <div
            class="user-list-container table-container"
            style="
              height: 300px;
              overflow-y: auto;
              border: 1px solid var(--border-surface);
            "
          >
            <table class="ruleset-table user-select-table">
              <thead>
                <tr>
                  <th style="width: 40px"></th>
                  <th style="text-align: center">이름</th>
                  <th style="text-align: center">직급</th>
                  <th style="text-align: center">이메일</th>
                </tr>
              </thead>
              <tbody id="user-list-body"></tbody>
            </table>
          </div>

          <div class="form-actions">
            <span
              id="selected-user-count"
              class="text-secondary text-sm"
              style="margin-right: auto"
              >선택된 사용자 없음</span
            >
            <button
              type="button"
              id="btn-confirm-add-member"
              class="btn-primary"
              disabled
            >
              추가
            </button>
            <button type="button" class="btn-secondary" id="btn-cancel-member">
              닫기
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay hidden" id="ruleset-modal">
      <div class="modal" role="dialog">
        <div class="modal-header">
          <h3 id="ruleset-modal-title">정책 설정</h3>
        </div>
        <div class="modal-content" id="ruleset-modal-body"></div>
      </div>
    </div>

    <template id="ruleset-form-template">
      <form id="ruleset-form" class="ruleset-form">
        <input type="hidden" name="group_id" id="ruleset-group-id" value="" />
        <input type="hidden" name="tenant_id" id="ruleset-tenant-id" value="" />
        <input
          type="hidden"
          name="target_agent"
          id="ruleset-target-agent"
          value=""
        />

        <div class="form-grid">
          <div class="form-group">
            <label for="ruleset-name-display">룰셋 이름</label>
            <input
              type="text"
              id="ruleset-name-display"
              readonly
              placeholder="자동 생성됨 (예: rule-1)"
            />
            <input type="hidden" id="ruleset-id" name="ruleset_id" required />
            <input type="hidden" id="ruleset-name" name="name" required />
          </div>

          <div class="form-group hidden" id="type-select-container">
            <select id="ruleset-type" name="type">
              <option value="tool_validation">Tool</option>
            </select>
          </div>
          <div
            class="form-group checkbox hidden"
            id="enabled-checkbox-container"
          >
            <input type="checkbox" name="enabled" checked />
          </div>
        </div>

        <div class="form-group">
          <label for="ruleset-description">설명</label>
          <textarea
            id="ruleset-description"
            name="description"
            placeholder="정책 설명"
            style="min-height: 60px"
          ></textarea>
        </div>

        <div id="target-selection-area" class="hidden form-section-box">
          <h4 class="section-title">
            <i class="fas fa-ban text-danger"></i> 접근 제한 대상 설정
          </h4>
          <p class="text-sm text-secondary" style="margin-bottom: 1rem">
            선택한 에이전트 및 Tool에 대한 접근을 <strong>차단</strong>합니다.
          </p>
          <div class="form-grid">
            <div class="form-group">
              <label>대상 에이전트</label>
              <select id="target-agent-select" name="target_agent_select">
                <option value="">에이전트 선택...</option>
              </select>
            </div>
            <div class="form-group">
              <label>대상 Tool</label>
              <select id="target-tool-select" name="tool_name_select" disabled>
                <option value="">에이전트를 먼저 선택하세요</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group hidden" id="tool-name-manual-container">
          <input type="text" name="tool_name" id="ruleset-tool-name" />
        </div>

        <div class="form-group hidden" id="validation-rules-container">
          <textarea name="rules" id="ruleset-rules"></textarea>
        </div>

        <div class="form-actions">
          <span class="status-message" id="ruleset-form-status"></span>
          <button type="submit" class="btn-primary">저장</button>
          <button type="button" class="btn-secondary" id="btn-cancel-ruleset">
            닫기
          </button>
        </div>
      </form>
    </template>

    <div class="modal-overlay hidden" id="group-modal">
      <div class="modal" style="width: 400px">
        <div class="modal-header">
          <h3 id="group-modal-title">그룹 관리</h3>
        </div>
        <div class="modal-content">
          <form id="group-form" class="ruleset-form">
            <input type="hidden" id="group-edit-id" />
            <div class="form-group">
              <label for="group-name">그룹 이름</label>
              <input
                type="text"
                id="group-name"
                name="name"
                required
                placeholder="예: 개발팀, 재무팀"
              />
            </div>
            <div class="form-group">
              <label for="group-desc">설명</label>
              <textarea id="group-desc" name="description" rows="3"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">저장</button>
              <button type="button" class="btn-secondary" id="btn-cancel-group">
                닫기
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
